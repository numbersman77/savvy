<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Regina Stegherr and Kaspar Rufibach">

<title>SAVVY: estimation of AE probabilities</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">
 <span class="menu-text">About SAVVY</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./publications.html">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./events.html">
 <span class="menu-text">Events and talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./code.html" aria-current="page">
 <span class="menu-text">Code</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#purpose-of-this-document" id="toc-purpose-of-this-document" class="nav-link" data-scroll-target="#purpose-of-this-document">Purpose of this document</a></li>
  <li><a href="#sas-code" id="toc-sas-code" class="nav-link" data-scroll-target="#sas-code">SAS code</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions">Functions</a></li>
  </ul></li>
  <li><a href="#estimation-of-ae-probabilities" id="toc-estimation-of-ae-probabilities" class="nav-link" data-scroll-target="#estimation-of-ae-probabilities">Estimation of AE probabilities</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SAVVY: estimation of AE probabilities</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Regina Stegherr and Kaspar Rufibach </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="background" class="level1">
<h1>Background</h1>
<p>The assessment of safety is an important aspect of the evaluation of new therapies in clinical trials, with analyses of adverse events being an essential part of this. Standard methods for the analysis of adverse events such as the incidence proportion, i.e.&nbsp;the number of patients with a specific adverse event out of all patients in the treatment groups, do not account for both varying follow-up times and competing risks. Alternative approaches such as the Aalen-Johansen estimator of the cumulative incidence function have been suggested. Theoretical arguments and numerical evaluations support the application of these more advanced methodology, but as yet there is to our knowledge only insufficient empirical evidence whether these methods would lead to different conclusions in safety evaluations. The Survival analysis for AdVerse events with VarYing follow-up times (SAVVY) project strives to close this gap in evidence by conducting a meta-analytical study to assess the impact of the methodology on the conclusion of the safety assessment empirically. Three papers are currently under review summarizing the rationale and results of the project:</p>
<ul>
<li><span class="citation" data-cites="stegherr_20_sap">Regina Stegherr et al. (<a href="#ref-stegherr_20_sap" role="doc-biblioref">2021</a>)</span>: Statistical analysis plan, presenting the rationale and statistical concept of the empirical study conducted as part of the SAVVY project. The statistical methods are presented in unified notation and examples of their implementation in R and SAS are provided. <a href="https://arxiv.org/abs/1912.00263">arxiv</a> | <a href="https://doi.org/10.1002/bimj.201900347">publication</a></li>
<li><span class="citation" data-cites="stegherr_20_1sample">R. Stegherr, Schmoor, Beyersmann, et al. (<a href="#ref-stegherr_20_1sample" role="doc-biblioref">2021</a>)</span>: 1-sample case, compares estimators of AE risk in one treatment arm. <a href="https://arxiv.org/abs/2008.07883">arxiv</a> | <a href="https://doi.org/10.1186/s13063-021-05354-x">publication</a></li>
<li><span class="citation" data-cites="rufibach_20_2sample">Rufibach et al. (<a href="#ref-rufibach_20_2sample" role="doc-biblioref">2022</a>)</span>: 2-sample case, compares relative risk estimators comparing two treatment arms based on (1) AE probabilities and (2) hazards. <a href="https://arxiv.org/abs/2008.07881">arxiv</a> | <a href="https://doi.org/10.1080/19466315.2022.2144944">publication</a></li>
</ul>
</section>
<section id="purpose-of-this-document" class="level1">
<h1>Purpose of this document</h1>
<p>This R markdown file provides easy accessible code to compute all the estimators for AE probabilities that are compared to each other in these papers. The github repository where this document is hosted is available <a href="https://github.com/numbersman77/savvy">here</a>.</p>
</section>
<section id="sas-code" class="level1">
<h1>SAS code</h1>
<p>The original SAS macros that were used by each sponsor to generate the summary data for the meta-analysis is available as supplement to <span class="citation" data-cites="stegherr_20_sap">Regina Stegherr et al. (<a href="#ref-stegherr_20_sap" role="doc-biblioref">2021</a>)</span>, see <a href="https://doi.org/10.1002/bimj.201900347">here</a>, or <a href="https://onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fbimj.201900347&amp;file=bimj2199-sup-0001-SuppMat.zip">direct download link</a> for zip-file.</p>
</section>
<section id="setup" class="level1 tabset tabset-fade tabset-pills">
<h1 class="tabset tabset-fade tabset-pills">Setup</h1>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># packages</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>packs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"data.table"</span>, <span class="st">"etm"</span>, <span class="st">"survival"</span>, <span class="st">"mvna"</span>, <span class="st">"knitr"</span>)    </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(packs)){<span class="fu">library</span>(packs[i], <span class="at">character.only =</span> <span class="cn">TRUE</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functions" class="level2">
<h2 class="anchored" data-anchor-id="functions">Functions</h2>
<p>Below all functions are defined.</p>
<ul>
<li><code>data_generation_constant_cens</code>: This function generates the dataset denoted by <span class="math inline">\(S1\)</span> in Table~4 of <span class="citation" data-cites="stegherr2020estimating">R. Stegherr, Schmoor, Lübbert, et al. (<a href="#ref-stegherr2020estimating" role="doc-biblioref">2021</a>)</span>, i.e.&nbsp;we assume constant hazards for the AE hazard, the hazard for the competing event of death, and the hazard for the “soft” competing events. Censoring is uniform.</li>
<li><code>incidenceProportion</code>: Compute incidence proportion.</li>
<li><code>probTransIncidenceDensity</code>: Compute probability transform incidence density ignoring competing events.</li>
<li><code>probTransIncidenceDensity</code>: Compute probability transform incidence density ignoring competing events.</li>
<li><code>oneMinusKaplanMeier</code>: Compute 1 - Kaplan-Meier estimator.</li>
<li><code>AJE</code>: Compute Aalen-Johansen estimator.</li>
</ul>
<p>The argument <code>CE</code> codifies the type of competing event: <code>CE = 2</code> refers to a competing event of <em>death only</em> whereas <code>CE = 3</code> refers to <em>all competing events</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># functions</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># function to generate dataset with constant hazards for AE, death, and soft competing events</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data_generation_constant_cens <span class="ot">&lt;-</span> <span class="cf">function</span>(N, min.cens, max.cens, haz.AE, haz.death,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                          haz.soft, <span class="at">seed =</span> <span class="dv">57</span> <span class="sc">*</span> i <span class="sc">+</span> <span class="dv">5</span>){</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># status, 1 for AE, 2 for death 3 for soft competing event</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  haz.all <span class="ot">&lt;-</span> haz.AE <span class="sc">+</span> haz.death <span class="sc">+</span> haz.soft</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  my.data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">time_to_event =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), <span class="at">type_of_event =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>time_to_event<span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="at">n =</span> N, <span class="at">rate =</span> haz.all) <span class="co"># event time</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>type_of_event <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> N, <span class="at">size =</span> <span class="dv">2</span>, </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prob =</span> <span class="fu">c</span>(haz.AE <span class="sc">/</span> haz.all, haz.death <span class="sc">/</span> haz.all, haz.soft <span class="sc">/</span> haz.all)) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="co"># status, 1 for AE, 2 for death 3 for soft competing event</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>cens <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> N, <span class="at">min =</span> min.cens, <span class="at">max =</span> max.cens)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>type_of_event <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(my.data<span class="sc">$</span>time_to_event <span class="sc">&lt;=</span> my.data<span class="sc">$</span>cens) <span class="sc">*</span> my.data<span class="sc">$</span>type_of_event</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>time_to_event <span class="ot">&lt;-</span> <span class="fu">pmin</span>(my.data<span class="sc">$</span>time_to_event, my.data<span class="sc">$</span>cens)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  my.data<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorder columns</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  my.data <span class="ot">&lt;-</span> my.data[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time_to_event"</span>, <span class="st">"type_of_event"</span>, <span class="st">"cens"</span>)]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(my.data)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># compute incidence proportion</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>incidenceProportion <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau){</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  ae <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data[type_of_event <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time_to_event <span class="sc">&lt;=</span> tau]) <span class="sc">/</span> <span class="fu">nrow</span>(data)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  ae_prob_var <span class="ot">&lt;-</span> ae <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> ae) <span class="sc">/</span> <span class="fu">nrow</span>(data)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ae_prob"</span> <span class="ot">=</span> ae, <span class="st">"ae_prob_var"</span> <span class="ot">=</span> ae_prob_var)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># compute probability transform incidence density</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>probTransIncidenceDensity <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau){</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> data<span class="sc">$</span>time_to_event</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  incidence.dens <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data[type_of_event <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time_to_event <span class="sc">&lt;=</span> tau]) <span class="sc">/</span> </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">ifelse</span>(time <span class="sc">&lt;=</span> tau, time, tau))</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  ae <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>incidence.dens <span class="sc">*</span> tau)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  var_A_var <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data[type_of_event <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time_to_event <span class="sc">&lt;=</span> tau]) <span class="sc">/</span> </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">ifelse</span>(time <span class="sc">&lt;=</span> tau, time, tau)) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  ae_var <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>incidence.dens <span class="sc">*</span> tau) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> var_A_var <span class="sc">*</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ae_prob"</span> <span class="ot">=</span> ae, <span class="st">"ae_prob_var"</span> <span class="ot">=</span> ae_var)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co"># compute probability transform incidence density accounting for CE</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>probTransIncidprobTransIncidenceDensityCompEvents <span class="ot">&lt;-</span> <span class="cf">function</span>(data, CE, tau){</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  data2 <span class="ot">&lt;-</span> data[, type_of_event2 <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(CE <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>type_of_event <span class="sc">==</span> <span class="dv">3</span>, <span class="dv">0</span>, </span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">ifelse</span>(CE <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>type_of_event <span class="sc">==</span> <span class="dv">3</span>, <span class="dv">2</span>, type_of_event))]</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  time2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data2<span class="sc">$</span>time_to_event <span class="sc">&lt;=</span> tau, data2<span class="sc">$</span>time_to_event, tau)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(time2)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dim</span>(data2[type_of_event2 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time_to_event <span class="sc">&lt;=</span> tau])[<span class="dv">1</span>]) <span class="sc">/</span> s2</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  id_ce <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dim</span>(data2[type_of_event2 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> time_to_event <span class="sc">&lt;=</span> tau])[<span class="dv">1</span>]) <span class="sc">/</span> s2</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> id <span class="sc">+</span> id_ce</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  ett <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>tau <span class="sc">*</span> tmp)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  ae_prob <span class="ot">&lt;-</span> id <span class="sc">/</span> tmp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span> tau<span class="sc">*</span>tmp))</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  ae_prob_var <span class="ot">&lt;-</span> (((ett <span class="sc">*</span>      (id_ce <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> ett <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span> tau <span class="sc">*</span> id <span class="sc">*</span> tmp)) <span class="sc">/</span> tmp <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> id <span class="sc">/</span> s2 <span class="sc">+</span> </span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>                  ((ett <span class="sc">*</span> id <span class="sc">*</span> (tau <span class="sc">*</span> tmp <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> ett <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">/</span> tmp <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> id_ce <span class="sc">/</span> s2)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ae_prob"</span> <span class="ot">=</span> ae_prob, <span class="st">"ae_prob_var"</span> <span class="ot">=</span> ae_prob_var)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="co"># compute 1 - Kaplan-Meier</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>oneMinusKaplanMeier <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau){</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(data[type_of_event <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    ae_prob <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    ae_prob_var <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(data[type_of_event <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    help <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>from <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>to <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>type_of_event <span class="sc">!=</span> <span class="dv">1</span>, <span class="st">"cens"</span>, data<span class="sc">$</span>type_of_event)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>time <span class="ot">&lt;-</span><span class="fu">ifelse</span>(data<span class="sc">$</span>time_to_event <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.001</span>, data<span class="sc">$</span>time_to_event)</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    tra <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">FALSE</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    tra[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    state.names <span class="ot">&lt;-</span><span class="fu">as.character</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    etmmm <span class="ot">&lt;-</span><span class="fu">etm</span>(help, state.names, tra, <span class="st">"cens"</span>, <span class="at">s =</span> <span class="dv">0</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    ae_prob <span class="ot">&lt;-</span> <span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]][<span class="fu">sum</span>(<span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>P</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    ae_prob_var <span class="ot">&lt;-</span> <span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]][<span class="fu">sum</span>(<span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>var</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ae_prob"</span> <span class="ot">=</span> ae_prob, <span class="st">"ae_prob_var"</span> <span class="ot">=</span> ae_prob_var)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a><span class="co"># compute Aalen-Johansen estimator</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>AJE <span class="ot">&lt;-</span> <span class="cf">function</span>(data, CE, tau){</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  data[, type_of_event2 <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(CE <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>type_of_event <span class="sc">==</span> <span class="dv">3</span>, <span class="dv">0</span>, </span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">ifelse</span>(CE <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>type_of_event <span class="sc">==</span> <span class="dv">3</span>, <span class="dv">2</span>, type_of_event))]</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> data<span class="sc">$</span>time_to_event</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>  type2 <span class="ot">&lt;-</span> data<span class="sc">$</span>type_of_event2</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditions</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  c1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data[type_of_event2 <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>  c2 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data[type_of_event2 <span class="sc">==</span> <span class="dv">2</span>])</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(c1 <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>   ae_prob <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>   ae_prob_var <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(c2 <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    ce_prob <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    ce_prob_var <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define auxiliary objects</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>  help <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id)</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>  help<span class="sc">$</span>from <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>  help<span class="sc">$</span>time <span class="ot">&lt;-</span><span class="fu">ifelse</span>(time <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.001</span>, time)</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>  tra <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">FALSE</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>  tra[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  state.names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(c1 <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> c2 <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>to <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(type2 <span class="sc">!=</span> <span class="dv">2</span>, <span class="st">"cens"</span>, type2 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>    etmmm <span class="ot">&lt;-</span> <span class="fu">etm</span>(help, state.names, tra, <span class="st">"cens"</span>, <span class="at">s =</span> <span class="dv">0</span>)</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    setmm <span class="ot">&lt;-</span> <span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]]</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    ce_prob <span class="ot">&lt;-</span> setmm[<span class="fu">sum</span>(setmm<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>P</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    ce_prob_var <span class="ot">&lt;-</span> setmm[<span class="fu">sum</span>(setmm<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>var</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(c1 <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> c2 <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>to <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(type2 <span class="sc">!=</span> <span class="dv">1</span>, <span class="st">"cens"</span>, type2)</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    etmmm <span class="ot">&lt;-</span> <span class="fu">etm</span>(help, state.names, tra, <span class="st">"cens"</span>, <span class="at">s =</span> <span class="dv">0</span>)</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    setmm <span class="ot">&lt;-</span> <span class="fu">summary</span>(etmmm)[[<span class="dv">2</span>]]</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    ae_prob <span class="ot">&lt;-</span> setmm[<span class="fu">sum</span>(setmm<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>P</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    ae_prob_var <span class="ot">&lt;-</span> setmm[<span class="fu">sum</span>(setmm<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>var</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(c1 <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> c2 <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    help<span class="sc">$</span>to <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="sc">!</span>(type2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)),<span class="st">"cens"</span>, type2)</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>    tra <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">FALSE</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    tra[<span class="dv">1</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>    state.names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>    etmmm <span class="ot">&lt;-</span> <span class="fu">etm</span>(help, state.names, tra, <span class="st">"cens"</span>, <span class="at">s =</span> <span class="dv">0</span>)</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>    setmm <span class="ot">&lt;-</span> <span class="fu">summary</span>(etmmm)</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>    ae_prob <span class="ot">&lt;-</span> setmm[[<span class="dv">2</span>]][<span class="fu">sum</span>(setmm[[<span class="dv">2</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>P</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>    ae_prob_var <span class="ot">&lt;-</span> setmm[[<span class="dv">2</span>]][<span class="fu">sum</span>(setmm[[<span class="dv">2</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>var</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>    ce_prob <span class="ot">&lt;-</span> setmm[[<span class="dv">3</span>]][<span class="fu">sum</span>(setmm[[<span class="dv">3</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>P</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    ce_prob_var <span class="ot">&lt;-</span> setmm[[<span class="dv">3</span>]][<span class="fu">sum</span>(setmm[[<span class="dv">3</span>]]<span class="sc">$</span>time <span class="sc">&lt;=</span> tau),]<span class="sc">$</span>var</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>  res_ae <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ae_prob"</span> <span class="ot">=</span> ae_prob, <span class="st">"ae_prob_var"</span> <span class="ot">=</span> ae_prob_var)</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>  res_ce <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ce_prob"</span> <span class="ot">=</span> ce_prob, <span class="st">"ce_prob_var"</span> <span class="ot">=</span> ce_prob_var)</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res_ae, res_ce)</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="estimation-of-ae-probabilities" class="level1">
<h1>Estimation of AE probabilities</h1>
<p>We generate the dataset <span class="math inline">\(S1\)</span> in <span class="citation" data-cites="stegherr_20_sap">Regina Stegherr et al. (<a href="#ref-stegherr_20_sap" role="doc-biblioref">2021</a>)</span> using the parameter values for Arm A:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample size</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># support of uniform censoring distribution</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>min.cens <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>max.cens <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># hazards for the three event types</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>haz.AE <span class="ot">&lt;-</span> <span class="fl">0.00265</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>haz.death <span class="ot">&lt;-</span> <span class="fl">0.00151</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>haz.soft <span class="ot">&lt;-</span> <span class="fl">0.00227</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># generate dataset</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>dat1 <span class="ot">&lt;-</span> <span class="fu">data_generation_constant_cens</span>(N, min.cens, max.cens, haz.AE, haz.death, haz.soft, <span class="at">seed =</span> <span class="dv">2020</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compute tau</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">max</span>(dat1[, <span class="st">"time_to_event"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The structure of the dataset looks as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(dat1, <span class="dv">10</span>), <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"crcr"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: right;">time_to_event</th>
<th style="text-align: center;">type_of_event</th>
<th style="text-align: right;">cens</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: right;">45.692951</td>
<td style="text-align: center;">1</td>
<td style="text-align: right;">424.518663</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: right;">197.519473</td>
<td style="text-align: center;">1</td>
<td style="text-align: right;">266.013197</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: right;">36.859040</td>
<td style="text-align: center;">2</td>
<td style="text-align: right;">650.432466</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: right;">115.062905</td>
<td style="text-align: center;">2</td>
<td style="text-align: right;">164.620580</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: right;">220.764432</td>
<td style="text-align: center;">1</td>
<td style="text-align: right;">994.178471</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: right;">8.499869</td>
<td style="text-align: center;">0</td>
<td style="text-align: right;">8.499869</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: right;">833.042670</td>
<td style="text-align: center;">0</td>
<td style="text-align: right;">833.042670</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: right;">37.389099</td>
<td style="text-align: center;">1</td>
<td style="text-align: right;">987.244922</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: right;">82.243862</td>
<td style="text-align: center;">2</td>
<td style="text-align: right;">556.460553</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: right;">75.843159</td>
<td style="text-align: center;">1</td>
<td style="text-align: right;">813.761866</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For this dataset we then compute all the estimators that enter the comparison in our papers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute each estimator</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>IP <span class="ot">&lt;-</span> <span class="fu">incidenceProportion</span>(dat1, tau)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>ID <span class="ot">&lt;-</span> <span class="fu">probTransIncidenceDensity</span>(dat1, tau)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>KM <span class="ot">&lt;-</span> <span class="fu">oneMinusKaplanMeier</span>(dat1, tau)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># competing event "death only"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>IDCE2 <span class="ot">&lt;-</span> <span class="fu">probTransIncidprobTransIncidenceDensityCompEvents</span>(dat1, <span class="at">CE =</span> <span class="dv">2</span>, tau)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>AJ2 <span class="ot">&lt;-</span> <span class="fu">AJE</span>(dat1, <span class="at">CE =</span> <span class="dv">2</span>, tau)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># account for all competing events</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>IDCE3 <span class="ot">&lt;-</span> <span class="fu">probTransIncidprobTransIncidenceDensityCompEvents</span>(dat1, <span class="at">CE =</span> <span class="dv">3</span>, tau)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>AJ3 <span class="ot">&lt;-</span> <span class="fu">AJE</span>(dat1, <span class="at">CE =</span> <span class="dv">3</span>, tau)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># display</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">rbind</span>(IP, ID, KM, IDCE2, AJ2[<span class="dv">1</span>, ], IDCE3, AJ3[<span class="dv">1</span>, ])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimated AE probability"</span>, <span class="st">"variance of estimation"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"incidence proportion"</span>, <span class="st">"probability transform incidence density ignoring competing event"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"1 - Kaplan-Meier"</span>, <span class="st">"probability transform incidence density (death only)"</span>, </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Aalen-Johansen (death only), AE risk"</span>, <span class="st">"probability transform incidence density (all CEs)"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Aalen-Johansen (all CEs), AE risk"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of AE</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tab, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 57%">
<col style="width: 22%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">estimated AE probability</th>
<th style="text-align: right;">variance of estimation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">incidence proportion</td>
<td style="text-align: right;">0.400</td>
<td style="text-align: right;">0.00120</td>
</tr>
<tr class="even">
<td style="text-align: left;">probability transform incidence density ignoring competing event</td>
<td style="text-align: right;">0.891</td>
<td style="text-align: right;">0.00073</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1 - Kaplan-Meier</td>
<td style="text-align: right;">0.832</td>
<td style="text-align: right;">0.00303</td>
</tr>
<tr class="even">
<td style="text-align: left;">probability transform incidence density (death only)</td>
<td style="text-align: right;">0.509</td>
<td style="text-align: right;">0.00157</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Aalen-Johansen (death only), AE risk</td>
<td style="text-align: right;">0.509</td>
<td style="text-align: right;">0.00164</td>
</tr>
<tr class="even">
<td style="text-align: left;">probability transform incidence density (all CEs)</td>
<td style="text-align: right;">0.472</td>
<td style="text-align: right;">0.00146</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Aalen-Johansen (all CEs), AE risk</td>
<td style="text-align: right;">0.471</td>
<td style="text-align: right;">0.00149</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Finally, the estimated probabilities of competing events based on the Aalen-Johansen estimators:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">rbind</span>(AJ2[<span class="dv">2</span>, ], AJ3[<span class="dv">2</span>, ])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimated probability"</span>, <span class="st">"variance of estimation"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Aalen-Johansen (death only), CE risk"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Aalen-Johansen (all CEs), CE risk"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of AE</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tab, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 45%">
<col style="width: 26%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">estimated probability</th>
<th style="text-align: right;">variance of estimation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Aalen-Johansen (death only), CE risk</td>
<td style="text-align: right;">0.466</td>
<td style="text-align: right;">0.00165</td>
</tr>
<tr class="even">
<td style="text-align: left;">Aalen-Johansen (all CEs), CE risk</td>
<td style="text-align: right;">0.507</td>
<td style="text-align: right;">0.00151</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-rufibach_20_2sample" class="csl-entry" role="doc-biblioentry">
Rufibach, Kaspar, Regina Stegherr, Claudia Schmoor, Valentine Jehl, Arthur Allignol, Annette Boeckenhoff, Cornelia Dunger-Baldauf, et al. 2022. <span>“<span class="nocase">Survival analysis for AdVerse events with VarYing follow-up times (SAVVY) – comparison of adverse event risks in randomized controlled trials</span>.”</span> <em>Statistics in Biopharmaceutical Research, Accepted</em>.
</div>
<div id="ref-stegherr_20_sap" class="csl-entry" role="doc-biblioentry">
Stegherr, Regina, Jan Beyersmann, Valentine Jehl, Kaspar Rufibach, Friedhelm Leverkus, Claudia Schmoor, and Tim Friede. 2021. <span>“Survival Analysis for AdVerse Events with VarYing Follow-up Times (SAVVY): Rationale and Statistical Concept of a Meta-Analytic Study.”</span> <em>Biometrical Journal</em> 63 (March): 650–70.
</div>
<div id="ref-stegherr_20_1sample" class="csl-entry" role="doc-biblioentry">
Stegherr, R., C. Schmoor, J. Beyersmann, K. Rufibach, V. Jehl, A. Brückner, L. Eisele, et al. 2021. <span>“<span class="nocase"><span>S</span>urvival analysis for <span>A</span>d<span>V</span>erse events with <span>V</span>ar<span>Y</span>ing follow-up times (<span>S</span><span>A</span><span>V</span><span>V</span><span>Y</span>)-estimation of adverse event risks</span>.”</span> <em>Trials</em> 22 (1): 420.
</div>
<div id="ref-stegherr2020estimating" class="csl-entry" role="doc-biblioentry">
Stegherr, R., C. Schmoor, M. Lübbert, T. Friede, and J. Beyersmann. 2021. <span>“<span class="nocase"><span>E</span>stimating and comparing adverse event probabilities in the presence of varying follow-up times and competing events</span>.”</span> <em>Pharmaceutical Statistics</em> 20 (6): 1125–46.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>